name: Weekly Newsletter Automation (Scheduled)

# Runs after the weekly portfolio automation completes successfully
# Triggered by workflow_run event when weekly-portfolio.yml completes

concurrency:
  group: newsletter-automation
  cancel-in-progress: false

on:
  workflow_run:
    workflows: ["Weekly Portfolio Update"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:  # Manual trigger
    inputs:
      week_number:
        description: 'Week number (leave empty to auto-detect)'
        required: false
        type: string
      overwrite:
        description: 'Overwrite existing blob if exists'
        required: false
        type: boolean
        default: false

jobs:
  generate-newsletter-complete:
    runs-on: ubuntu-latest
    # Only run if portfolio workflow succeeded OR if manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      id-token: write  # Required for Azure login
      contents: write  # Required for committing generated files
      issues: write    # For failure notifications

    steps:
      - name: Check portfolio workflow status
        if: github.event_name == 'workflow_run'
        run: |
          echo "Portfolio workflow completed with status: ${{ github.event.workflow_run.conclusion }}"
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ Portfolio workflow did not succeed. Skipping newsletter generation."
            exit 1
          fi
          echo "âœ… Portfolio workflow succeeded. Proceeding with newsletter generation."

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main  # Ensure we're on the latest main branch with portfolio updates
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: scripts/requirements.txt

      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt
          pip list  # Show versions for debugging

      - name: Determine week number
        id: week
        run: |
          if [ -n "${{ github.event.inputs.week_number }}" ]; then
            WEEK_NUM="${{ github.event.inputs.week_number }}"
          else
            # Auto-detect latest week from blog posts
            WEEK_NUM=$(ls Posts/GenAi-Managed-Stocks-Portfolio-Week-*.html 2>/dev/null | grep -oP 'Week-\K\d+' | sort -n | tail -1)
            if [ -z "$WEEK_NUM" ]; then
              echo "âŒ No blog posts found. Portfolio automation may have failed."
              exit 1
            fi
          fi
          echo "week=$WEEK_NUM" >> $GITHUB_OUTPUT
          echo "ðŸ“… Processing Week $WEEK_NUM"

          # Verify the blog post and data files exist
          BLOG_FILE="Posts/GenAi-Managed-Stocks-Portfolio-Week-${WEEK_NUM}.html"
          DATA_FILE="Data/W${WEEK_NUM}/master.json"

          if [ ! -f "$BLOG_FILE" ]; then
            echo "âŒ Blog post not found: $BLOG_FILE"
            exit 1
          fi

          if [ ! -f "$DATA_FILE" ]; then
            echo "âŒ Portfolio data not found: $DATA_FILE"
            exit 1
          fi

          echo "âœ… Verified blog post and data files exist for Week $WEEK_NUM"

      - name: Stage 1 - Generate Newsletter Narrative
        id: narrative
        timeout-minutes: 5
        env:
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
        run: |
          echo "ðŸ“‹ Stage 1: Generating newsletter narrative..."
          python scripts/generate_newsletter_narrative.py ${{ steps.week.outputs.week }} 2>&1 | tee narrative.log

          # Validate output
          NARRATIVE_FILE="newsletters/week${{ steps.week.outputs.week }}_narrative.json"
          if [ ! -f "$NARRATIVE_FILE" ]; then
            echo "âŒ Narrative JSON not created: $NARRATIVE_FILE"
            exit 1
          fi
          echo "âœ… Narrative JSON generated: $NARRATIVE_FILE"

      - name: Stage 2 - Generate Newsletter HTML
        id: html
        timeout-minutes: 3
        run: |
          echo "ðŸ“§ Stage 2: Generating newsletter HTML..."
          python scripts/generate_newsletter_html.py ${{ steps.week.outputs.week }} 2>&1 | tee html.log

          # Validate output
          HTML_FILE="newsletters/week${{ steps.week.outputs.week }}_newsletter.html"
          if [ ! -f "$HTML_FILE" ]; then
            echo "âŒ Newsletter HTML not created: $HTML_FILE"
            exit 1
          fi

          # Check HTML file size (should be > 10 KB)
          HTML_SIZE=$(stat -c%s "$HTML_FILE" 2>/dev/null || stat -f%z "$HTML_FILE")
          if [ "$HTML_SIZE" -lt 10000 ]; then
            echo "âš ï¸ Warning: HTML file size is unusually small ($HTML_SIZE bytes)"
          fi
          echo "âœ… Newsletter HTML generated: $HTML_FILE ($HTML_SIZE bytes)"

      - name: Azure Login (Managed Identity)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Stage 3 - Upload to Azure Blob Storage
        id: upload
        timeout-minutes: 3
        env:
          STORAGE_ACCOUNT_NAME: ${{ secrets.STORAGE_ACCOUNT_NAME }}
        run: |
          echo "â˜ï¸ Stage 3: Uploading newsletter to Azure Blob Storage..."

          OVERWRITE_FLAG=""
          if [ "${{ github.event.inputs.overwrite }}" == "true" ]; then
            OVERWRITE_FLAG="--overwrite"
          fi

          python scripts/upload_newsletter_to_blob.py ${{ steps.week.outputs.week }} $OVERWRITE_FLAG 2>&1 | tee upload.log
          echo "âœ… Newsletter uploaded to blob: newsletters/week${{ steps.week.outputs.week }}.html"

      - name: Commit newsletter files to repository
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Add newsletter files
          git add newsletters/week${{ steps.week.outputs.week }}_narrative.json \
                  newsletters/week${{ steps.week.outputs.week }}_newsletter.html

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“§ Weekly newsletter - Week ${{ steps.week.outputs.week }} [automated]"
            git push
            echo "âœ… Newsletter files committed to repository"
          fi

      - name: Upload execution artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newsletter-execution-${{ github.run_number }}
          path: |
            newsletters/week${{ steps.week.outputs.week }}_narrative.json
            newsletters/week${{ steps.week.outputs.week }}_newsletter.html
            narrative.log
            html.log
            upload.log
          retention-days: 30
          if-no-files-found: warn

      - name: Create success summary
        if: success()
        run: |
          echo "# âœ… Newsletter Automation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Week ${{ steps.week.outputs.week }} Newsletter Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Completed Stages:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Stage 1: Narrative JSON generated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Stage 2: Newsletter HTML created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Stage 3: Uploaded to Azure Blob Storage" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Files committed to repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Azure Blob Storage:" >> $GITHUB_STEP_SUMMARY
          echo "- **Container**: newsletters" >> $GITHUB_STEP_SUMMARY
          echo "- **Blob**: week${{ steps.week.outputs.week }}.html" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Azure Function will detect the new blob automatically" >> $GITHUB_STEP_SUMMARY
          echo "2. Newsletter will be sent to subscribers on next scheduled run" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify in Azure Portal: Function App â†’ weekly_newsletter â†’ Monitor" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const week = '${{ steps.week.outputs.week }}' || 'unknown';

            let failedStage = 'Unknown';
            if ('${{ steps.narrative.outcome }}' === 'failure') failedStage = 'Stage 1 (Narrative Generation)';
            else if ('${{ steps.html.outcome }}' === 'failure') failedStage = 'Stage 2 (HTML Generation)';
            else if ('${{ steps.upload.outcome }}' === 'failure') failedStage = 'Stage 3 (Azure Upload)';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Newsletter Automation Failed - Week ${week}`,
              body: `**Workflow Failed**: [View Run](${runUrl})

            **Week**: ${week}
            **Failed Stage**: ${failedStage}
            **Trigger**: ${context.eventName}
            **Branch**: ${context.ref}

            ### Investigation Steps:
            1. Check workflow logs: [Run #${context.runNumber}](${runUrl})
            2. Verify blog post exists: Posts/GenAi-Managed-Stocks-Portfolio-Week-${week}.html
            3. Check portfolio data: Data/W${week}/master.json
            4. Review Azure credentials (AZURE_OPENAI_*, AZURE_CLIENT_ID, etc.)
            5. Verify Azure Blob Storage access and permissions`,
              labels: ['automation', 'newsletter', 'bug', 'high-priority']
            });
