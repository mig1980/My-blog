<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio Stock Heatmap – GenAi Portfolio</title>
  <meta name="description" content="Interactive heatmap visualization of individual stock performance in the AI-managed portfolio." />
  <link rel="canonical" href="https://quantuminvestor.net/Posts/portfolio-heatmap.html" />
  <link rel="icon" href="../Media/favicon.ico" />
  <link rel="stylesheet" href="../styles.css" />
  <script src="../js/template-loader.js" defer></script>
  <script src="../js/mobile-menu.js" defer></script>
  <style>
    body { font-family: system-ui, sans-serif; }
    
    .view-toggle { display:flex; gap:.75rem; margin:1.5rem 0; }
    .view-toggle button { background:#181818; border:1px solid #282828; padding:.6rem 1.2rem; font-size:.85rem; border-radius:.5rem; cursor:pointer; transition:all .2s; }
    .view-toggle button.active { background:#7e5bef; border-color:#9575ff; color:white; }
    
    .heatmap-container { display:grid; gap:.5rem; margin:2rem 0; }
    
    /* Grid view */
    .heatmap-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:.75rem; }
    .heat-cell { 
      position:relative; 
      padding:1.25rem 1rem; 
      border-radius:.75rem; 
      border:1px solid rgba(255,255,255,.1); 
      cursor:pointer;
      transition:all .25s ease;
      display:flex;
      flex-direction:column;
      gap:.5rem;
    }
    .heat-cell:hover { transform:translateY(-4px); border-color:rgba(255,255,255,.3); box-shadow:0 8px 24px rgba(0,0,0,.4); }
    .heat-cell .ticker { font-size:1.1rem; font-weight:700; letter-spacing:.02em; }
    .heat-cell .company { font-size:.7rem; color:#999; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .heat-cell .perf { font-size:1.5rem; font-weight:700; margin:.25rem 0; }
    
    /* List view */
    .heatmap-list { display:flex; flex-direction:column; gap:.5rem; }
    .heat-row { 
      display:grid; 
      /* Simplified: ticker, company, performance bar */
      grid-template-columns: 80px 1fr 180px; 
      gap:1rem; 
      align-items:center; 
      padding:1rem 1.25rem; 
      background:#0c0c0c; 
      border:1px solid #222; 
      border-radius:.5rem;
      cursor:pointer;
      transition:all .2s;
    }
    .heat-row:hover { background:#141414; border-color:#333; }
    .heat-row .ticker { font-weight:700; font-size:1rem; }
    .heat-row .company { font-size:.8rem; color:#aaa; }
    .heat-row .perf-bar-container { position:relative; height:24px; background:#1a1a1a; border-radius:.3rem; overflow:hidden; }
    .heat-row .perf-bar { height:100%; border-radius:.3rem; transition:width .3s; }
    .heat-row .perf-label { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:.75rem; font-weight:700; z-index:1; color:#fff; }
    
    .legend { display:flex; gap:1.5rem; align-items:center; margin:1rem 0; font-size:.75rem; }
    .legend-item { display:flex; align-items:center; gap:.5rem; }
    .legend-box { width:20px; height:20px; border-radius:.3rem; }

    /* Hover tooltip */
    .hover-tooltip { position:fixed; pointer-events:none; z-index:200; background:#0f0f0f; border:1px solid #333; border-radius:.65rem; padding:.9rem 1rem; width:260px; box-shadow:0 8px 24px rgba(0,0,0,.6); opacity:0; transform:translateY(4px); transition:opacity .15s ease, transform .15s ease; font-size:.72rem; }
    .hover-tooltip.visible { opacity:1; transform:translateY(0); }
    .hover-tooltip h4 { margin:0 0 .4rem 0; font-size:.9rem; font-weight:600; letter-spacing:.02em; display:flex; justify-content:space-between; }
    .hover-tooltip .metric { display:flex; justify-content:space-between; padding:.25rem 0; }
    .hover-tooltip .metric span:first-child { color:#888; }
    .hover-tooltip .perf-large { font-size:1.25rem; font-weight:700; margin:.25rem 0 .35rem 0; }

    /* Week selector */
    .week-toggle { display:flex; align-items:center; gap:.5rem; margin:1rem 0 0 0; flex-wrap:wrap; }
    .week-toggle label { font-size:.75rem; text-transform:uppercase; letter-spacing:.08em; color:#888; }
    #weekSelect { background:#181818; color:#eee; border:1px solid #282828; padding:.45rem .75rem; border-radius:.5rem; font-size:.8rem; cursor:pointer; }
    #weekSelect:focus { outline:2px solid #7e5bef; outline-offset:2px; }
    .week-badge { background:#222; padding:.35rem .6rem; border-radius:.4rem; font-size:.65rem; letter-spacing:.05em; color:#bbb; }
    
    @media (max-width:768px){
      .heat-row { grid-template-columns: 70px 1fr 100px; gap:.5rem; padding:.75rem 1rem; }
      .heatmap-grid { grid-template-columns:1fr; }
    }
  </style>
</head>
<body class="bg-black text-white">
  <div data-template="header" data-root-path="../"></div>
  <main class="container mx-auto px-4 py-10 max-w-6xl">
    <h1 class="text-3xl font-bold mb-2">Portfolio Stock Heatmap</h1>
    <p class="text-gray-400 mb-4 text-sm">Interactive visualization of individual stock performance.</p>
    <div class="week-toggle">
      <label for="weekSelect">Week</label>
      <select id="weekSelect"></select>
      <span id="weekMeta" class="week-badge" title="Auto-selected latest week"></span>
    </div>

    <div class="view-toggle">
      <button id="btnGrid" class="active">Grid View</button>
      <button id="btnList">List View</button>
      <button id="btnWeekly" data-metric="weekly">Weekly %</button>
      <button id="btnTotal" data-metric="total" class="active">Total %</button>
    </div>
    
    <div class="legend">
      <div class="legend-item"><div class="legend-box" style="background:#16a34a;"></div><span>Gain</span></div>
      <div class="legend-item"><div class="legend-box" style="background:#333;"></div><span>Flat</span></div>
      <div class="legend-item"><div class="legend-box" style="background:#f87171;"></div><span>Loss</span></div>
    </div>
    
    <div id="heatmapContainer" class="heatmap-container"></div>
    
    <div class="panel mt-8" style="background:#0c0c0c; border:1px solid #222; padding:1.5rem; border-radius:.75rem;">
      <h2 class="text-xl font-bold mb-3">About This Visualization</h2>
      <p class="text-sm text-gray-300 leading-relaxed">
        The heatmap provides an at-a-glance view of portfolio composition and individual stock performance. 
        Color intensity represents performance magnitude—greens indicate gains, reds show losses, and gray represents flat performance. 
        Each cell displays the ticker, company name, and current performance percentage. 
        Toggle between weekly and total performance metrics to analyze different timeframes. 
        Hover over any stock to view detailed metrics including shares, value, and portfolio weight.
      </p>
    </div>
  </main>
  
  <div data-template="footer" data-root-path="../"></div>

<script>
(async function init(){
  // Load consolidated master data
  const weekSelect = document.getElementById('weekSelect');
  const weekMeta = document.getElementById('weekMeta');
  let masterData = null;
  let availableWeeks = [];
  let currentWeek = null;
  let stocks = [];

  let currentView = 'grid'; // 'grid' or 'list'
  let currentMetric = 'total'; // 'weekly' or 'total'

  async function loadMasterData(){
    const res = await fetch('../master data/master.json');
    masterData = await res.json();
    
    // Discover available weeks from portfolio_history
    // First entry (index 0) is inception (W0), subsequent entries are W1, W2, etc.
    // Only include weeks that have complete stock price data
    for (let i = 1; i < masterData.portfolio_history.length; i++) {
      const weekDate = masterData.portfolio_history[i].date;
      const hasData = masterData.stocks.every(stock => stock.prices[weekDate] !== undefined);
      if (hasData) {
        availableWeeks.push(`W${i}`);
      } else {
        console.warn(`Skipping W${i} (${weekDate}) - missing stock price data`);
      }
    }
    return availableWeeks;
  }

  function populateWeekSelect(){
    weekSelect.innerHTML = '';
    availableWeeks.forEach(w => {
      const opt = document.createElement('option');
      opt.value = w;
      opt.textContent = w;
      if(w === currentWeek) opt.selected = true;
      weekSelect.appendChild(opt);
    });
    weekMeta.textContent = `Latest: ${availableWeeks[availableWeeks.length-1]}`;
  }
  
  function formatPct(pct) {
    if (pct === null || pct === undefined) return 'N/A';
    return (pct > 0 ? '+' : '') + pct.toFixed(2) + '%';
  }

  function extractWeekData(weekIndex){
    // Extract data for specific week from master data
    const weekEntry = masterData.portfolio_history[weekIndex];
    const date = weekEntry.date;
    
    // Use pre-calculated metrics from master data stocks array
    const weekStocks = masterData.stocks.map(stock => {
      const priceAtWeek = stock.prices[date];
      const priceAtInception = stock.prices[masterData.meta.inception_date];
      
      // Calculate weekly change (compare to previous week)
      let weekly_pct = 0;
      if (weekIndex > 1) {
        const prevDate = masterData.portfolio_history[weekIndex - 1].date;
        const prevPrice = stock.prices[prevDate];
        if (prevPrice && priceAtWeek) {
          weekly_pct = ((priceAtWeek - prevPrice) / prevPrice) * 100;
        }
      } else if (weekIndex === 1) {
        // Week 1 compares to inception (index 0)
        if (priceAtInception && priceAtWeek) {
          weekly_pct = ((priceAtWeek - priceAtInception) / priceAtInception) * 100;
        }
      }
      
      // Calculate total change from inception
      const total_pct = priceAtInception && priceAtWeek 
        ? ((priceAtWeek - priceAtInception) / priceAtInception) * 100 
        : 0;
      
      return {
        ticker: stock.ticker,
        name: stock.name,
        shares: stock.shares,
        current_price: priceAtWeek,
        current_value: priceAtWeek ? stock.shares * priceAtWeek : 0,
        weekly_pct: weekly_pct,
        total_pct: total_pct,
        prices: stock.prices
      };
    });
    
    return {
      date: date,
      stocks: weekStocks,
      portfolio: weekEntry
    };
  }

  async function loadWeek(){
    if(!currentWeek || !masterData) return;
    
    const weekNum = parseInt(currentWeek.substring(1));
    // Week numbers map directly to array indices (W1 = index 1, W2 = index 2, etc.)
    const weekIndex = weekNum;
    
    if (weekIndex < 1 || weekIndex >= masterData.portfolio_history.length) {
      console.error('Invalid week index:', weekIndex);
      return;
    }
    
    const weekData = extractWeekData(weekIndex);
    stocks = weekData.stocks;
    renderHeatmap();
  }

  function getColor(pct) {
    if (pct === null || pct === undefined) return '#333';
    if (pct > 0.01) return '#16a34a';      // Gain
    if (pct < -0.01) return '#f87171';     // Loss
    return '#333';                         // Flat (within +/-0.01%)
  }

  function renderHeatmap() {
    const container = document.getElementById('heatmapContainer');
    container.innerHTML = '';
    if(!stocks || !stocks.length){
      container.textContent = 'No data available for selected week.';
      return;
    }

    if (currentView === 'grid') {
      container.className = 'heatmap-container heatmap-grid';
      stocks.forEach(stock => {
        const pct = currentMetric === 'weekly' ? stock.weekly_pct : stock.total_pct;
        const color = getColor(pct);
        const cell = document.createElement('div');
        cell.className = 'heat-cell';
        cell.style.background = `linear-gradient(135deg, ${color}22 0%, ${color}11 100%)`;
        cell.style.borderColor = `${color}44`;
        cell.innerHTML = `
          <div class="ticker">${stock.ticker}</div>
          <div class="company">${stock.name}</div>
          <div class="perf" style="color:${color};">${formatPct(pct)}</div>
        `;
        attachHover(cell, stock, pct);
        container.appendChild(cell);
      });
    } else {
      container.className = 'heatmap-container heatmap-list';
      const sorted = [...stocks].sort((a, b) => {
        const aVal = currentMetric === 'weekly' ? a.weekly_pct : a.total_pct;
        const bVal = currentMetric === 'weekly' ? b.weekly_pct : b.total_pct;
        return bVal - aVal;
      });
      const maxPct = Math.max(...stocks.map(s => Math.abs(currentMetric === 'weekly' ? s.weekly_pct : s.total_pct)));
      sorted.forEach(stock => {
        const pct = currentMetric === 'weekly' ? stock.weekly_pct : stock.total_pct;
        const row = document.createElement('div');
        row.className = 'heat-row';
        const barWidth = Math.min(100, (Math.abs(pct) / maxPct) * 100);
        const barAlign = pct >= 0 ? 'left' : 'right';
        row.innerHTML = `
          <div class="ticker">${stock.ticker}</div>
          <div class="company">${stock.name}</div>
          <div class="perf-bar-container">
            <div class="perf-bar" style="width:${barWidth}%; background:${getColor(pct)}; float:${barAlign};"></div>
            <div class="perf-label">${formatPct(pct)}</div>
          </div>
        `;
        attachHover(row, stock, pct);
        container.appendChild(row);
      });
    }
  }

  // Tooltip helper
  const tooltip = document.createElement('div');
  tooltip.className = 'hover-tooltip';
  document.body.appendChild(tooltip);

  function attachHover(el, stock, pct){
    el.addEventListener('mouseenter', () => {
      const weekIndex = parseInt(currentWeek.substring(1));
      const portfolioValue = masterData.portfolio_history[weekIndex]?.value || 0;
      const weight = portfolioValue > 0 ? ((stock.current_value / portfolioValue) * 100).toFixed(2) : '--';
      tooltip.innerHTML = `
        <h4><span>${stock.ticker}</span><span>${currentWeek}</span></h4>
        <div class="perf-large" style="color:${getColor(pct)}">${formatPct(pct)}</div>
        <div class="metric"><span>Company</span><span style="max-width:140px; text-align:right; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${stock.name}</span></div>
        <div class="metric"><span>Shares</span><span>${stock.shares.toFixed(4)}</span></div>
        <div class="metric"><span>Value</span><span>$${stock.current_value.toLocaleString()}</span></div>
        <div class="metric"><span>Weekly %</span><span style="color:${getColor(stock.weekly_pct)}">${formatPct(stock.weekly_pct)}</span></div>
        <div class="metric"><span>Total %</span><span style="color:${getColor(stock.total_pct)}">${formatPct(stock.total_pct)}</span></div>
        <div class="metric"><span>Weight</span><span>${weight}%</span></div>
      `;
      tooltip.classList.add('visible');
    });
    el.addEventListener('mousemove', (e) => {
      const offset = 16;
      let x = e.clientX + offset;
      let y = e.clientY + offset;
      const rect = tooltip.getBoundingClientRect();
      if (x + rect.width > window.innerWidth - 10){ x = e.clientX - rect.width - offset; }
      if (y + rect.height > window.innerHeight - 10){ y = e.clientY - rect.height - offset; }
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
    });
    el.addEventListener('mouseleave', () => {
      tooltip.classList.remove('visible');
    });
  }

  // View toggles
  document.getElementById('btnGrid').addEventListener('click', () => {
    currentView = 'grid';
    document.getElementById('btnGrid').classList.add('active');
    document.getElementById('btnList').classList.remove('active');
    renderHeatmap();
  });
  document.getElementById('btnList').addEventListener('click', () => {
    currentView = 'list';
    document.getElementById('btnList').classList.add('active');
    document.getElementById('btnGrid').classList.remove('active');
    renderHeatmap();
  });

  // Metric toggles
  document.getElementById('btnWeekly').addEventListener('click', () => {
    currentMetric = 'weekly';
    document.getElementById('btnWeekly').classList.add('active');
    document.getElementById('btnTotal').classList.remove('active');
    renderHeatmap();
  });
  document.getElementById('btnTotal').addEventListener('click', () => {
    currentMetric = 'total';
    document.getElementById('btnTotal').classList.add('active');
    document.getElementById('btnWeekly').classList.remove('active');
    renderHeatmap();
  });

  // Week change
  weekSelect.addEventListener('change', async () => {
    currentWeek = weekSelect.value;
    await loadWeek();
  });

  // Load master data & initial load
  try {
    await loadMasterData();
  } catch (e){
    console.error('Failed to load master data:', e);
    document.getElementById('heatmapContainer').textContent = 'Error loading portfolio data.';
    return;
  }
  if(availableWeeks.length === 0){
    document.getElementById('heatmapContainer').textContent = 'No weeks available.';
    return;
  }
  currentWeek = availableWeeks[availableWeeks.length - 1];
  populateWeekSelect();
  await loadWeek();
})();
</script>
</body>
</html>
